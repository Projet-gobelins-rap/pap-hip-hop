<template>
  <section class="graffDraw">
    <span class="graffDraw-cursor"></span>
    <picture class="graffDraw-background">
      <img class="graffDraw-background--img" :src="wallTexture.src" alt="" />
    </picture>
    <div class="graffDraw-preview"></div>
    <div class="graffDraw-container">
      <svg
        class="graffDraw-stroke"
        width="969"
        height="566"
        viewBox="0 0 969 566"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M229.097 188.502L242.967 162.142L229.097 188.502ZM229.097 188.502L237.706 207.899L215.705 252.165L218.575 263.604L229.097 188.502ZM229.097 188.502L202.313 176.504L229.097 188.502ZM126.266 146.723H135.832L202.313 176.504L126.266 146.723ZM126.266 146.723L83.2208 240.228L85.3731 243.709L126.266 146.723ZM126.266 146.723C109.686 151.034 73.4639 162.54 61.2199 174.078C45.9148 188.502 15.7831 244.207 20.0876 263.604L53.5675 281.509C55.1618 284.327 56.7242 293.147 50.2196 305.88C43.7149 318.612 29.0157 352.632 22.4792 368.05C21.3299 370.355 20.9077 374.664 23.4849 379.987L126.266 146.723ZM112.396 261.117L87.5254 247.191L85.3731 243.709L112.396 261.117ZM112.396 261.117L119.092 272.059L83.2208 355.616L87.5254 368.05L124.353 396.897L141.093 404.358L168.355 384.463L181.269 386.453L190.356 400.379L202.313 409.829L112.396 261.117ZM112.396 261.117C105.509 271.462 81.7861 279.022 70.7857 281.509L112.396 261.117ZM242.967 162.142L308.014 191.486L242.967 162.142ZM242.967 162.142C240.672 156.358 214.907 169.307 202.313 176.504L242.967 162.142ZM308.014 191.486L319.971 203.423L308.014 191.486ZM308.014 191.486L340.059 169.371L308.014 191.486ZM519.415 273.551C520.211 261.946 521.328 234.06 519.415 215.36C517.501 196.659 496.616 178.389 486.413 171.592C473.786 158.063 433.004 159.655 414.192 162.142C391.235 165.325 376.886 155.179 360.625 155.179L340.059 169.371L519.415 273.551ZM519.415 273.551C526.429 265.427 544.19 249.578 559.112 251.17L519.415 273.551ZM519.415 273.551C520.053 286.151 524.484 318.911 537.111 349.15C542.85 363.077 543.01 391.758 542.372 404.358L519.415 273.551ZM559.112 251.17C558.473 251.115 554.7 235.563 552.894 227.794C551.459 220.665 556.147 202.428 586.374 186.512L559.112 251.17ZM559.112 251.17C568.04 251.998 588.096 256.74 596.896 269.075C587.331 244.253 571.834 192.992 586.374 186.512L559.112 251.17ZM586.374 186.512C624.158 166.618 662.421 167.115 668.16 172.089C672.752 176.068 678.045 183.362 680.117 186.512H586.374ZM680.117 186.512C681.722 191.606 683.751 198.09 685.868 204.915L680.117 186.512ZM680.117 186.512C683.696 179.516 697.119 166.078 723.641 162.83L680.117 186.512ZM811.645 201.433C808.584 192.68 792.832 179.218 785.34 173.581C781.672 169.436 766.113 161.346 733.207 162.142C729.845 162.223 726.658 162.461 723.641 162.83L811.645 201.433ZM811.645 201.433C818.805 190.962 833.347 173.192 847.994 163.661L811.645 201.433ZM811.645 201.433C813.915 215.691 817.572 245.4 814.036 250.175L811.645 201.433ZM897.258 292.948C898.214 281.012 935.52 210.386 939.825 203.92C944.129 197.454 949.869 184.026 949.869 177.56C949.39 155.676 890.083 157.665 866.169 157.168C860.463 157.049 854.22 159.611 847.994 163.661L897.258 292.948ZM897.258 292.948C896.492 302.498 893.431 307.538 891.996 308.864L875.735 322.293L897.258 292.948ZM897.258 292.948C885.396 304.089 867.444 293.943 859.952 287.477L897.258 292.948ZM875.735 322.293L887.214 334.23C903.954 345.503 927.389 376.108 887.214 408.337C847.038 440.566 837.313 444.313 837.472 442.157C821.689 444.644 789.357 439.372 786.296 398.389C784.657 376.439 819.696 341.701 844.168 328.721L875.735 322.293ZM875.735 322.293L853.256 324.78L875.735 322.293ZM853.256 324.78L827.428 308.864L853.256 324.78ZM853.256 324.78C850.487 325.655 847.421 326.996 844.168 328.721L853.256 324.78ZM827.428 308.864L814.036 250.175L827.428 308.864ZM827.428 308.864L859.952 287.477L827.428 308.864ZM814.036 250.175C803.993 264.599 779.6 292.252 762.382 287.477L814.036 250.175ZM762.382 287.477C768.352 292.238 775.024 299.522 780.429 308.864L762.382 287.477ZM762.382 287.477C755.439 287.477 740.039 272.225 733.207 264.599C724.279 275.872 709.867 296.231 723.641 287.477C737.416 278.724 767.239 298.088 780.429 308.864L762.382 287.477ZM764.295 412.813L727.946 452.602C716.467 456.415 687.961 459.167 677.248 443.65L764.295 412.813ZM764.295 412.813C799.757 369.933 794.22 332.702 780.429 308.864L764.295 412.813ZM764.295 412.813C741.338 410.326 693.892 407.143 687.77 414.305L764.295 412.813ZM677.248 443.65L662.899 460.56H652.855C647.753 450.613 631.62 435.99 607.897 457.078C606.462 459.068 599.766 457.078 600.244 452.602L677.248 443.65ZM677.248 443.65L690.64 427.734L677.248 443.65ZM600.244 452.602C600.723 448.126 592.113 463.047 577.765 447.628L600.244 452.602ZM600.244 452.602L623.68 416.792L600.244 452.602ZM577.765 447.628C575.852 446.136 558.634 471.502 527.545 442.157L577.765 447.628ZM577.765 447.628C584.142 438.676 596.896 419.975 596.896 416.792L577.765 447.628ZM527.545 442.157L519.415 452.602C517.98 455.255 512.049 460.56 499.805 460.56C487.561 460.56 460.586 460.56 448.629 460.56L420.41 452.602L527.545 442.157ZM527.545 442.157L539.981 422.263L527.545 442.157ZM420.41 452.602L410.844 460.56H375.691L420.41 452.602ZM420.41 452.602L441.933 416.792L453.412 388.442L420.41 452.602ZM226.706 449.121C280.273 437.681 325.55 450.779 340.537 460.56H375.691L226.706 449.121ZM226.706 449.121C182.614 458.537 161.181 449.618 138.702 425.247L226.706 449.121ZM226.706 449.121C241.114 437.515 269.53 411.52 267.928 400.379L226.706 449.121ZM135.832 414.802C132.643 416.461 123.492 420.87 112.396 425.247C101.3 429.624 85.7718 425.081 79.3948 422.263C74.7714 418.947 60.5505 409.232 40.6539 396.897C31.0025 390.914 25.9127 385.001 23.4849 379.987L135.832 414.802ZM70.7857 363.574C56.1512 367.553 26.2027 376.406 23.4849 379.987L70.7857 363.574ZM32.0448 258.133C36.8276 253.657 54.1891 244.505 85.3731 243.709L32.0448 258.133ZM218.575 263.604C210.763 266.091 195.043 275.541 194.661 293.446L218.575 263.604ZM218.575 263.604C233.025 261.436 262.609 266.447 278.839 299.372L218.575 263.604ZM319.971 203.423L278.839 272.059L319.971 203.423ZM319.971 203.423C311.202 218.012 298.352 247.688 317.101 249.678L319.971 203.423ZM317.101 249.678C322.84 244.704 334.702 233.265 336.232 227.296L317.101 249.678ZM317.101 249.678L326.667 263.604L317.101 249.678ZM336.232 227.296C338.146 219.836 341.493 176.601 340.059 169.371L336.232 227.296ZM336.232 227.296C340.546 228.63 350.013 230.94 360.625 232.084L336.232 227.296ZM372.582 232.767C368.574 232.767 364.522 232.504 360.625 232.084L372.582 232.767ZM278.839 299.372C281.232 304.228 283.335 309.691 285.056 315.827C298.448 363.574 268.954 398.389 252.533 409.829C258.186 405.846 263.284 402.767 267.928 400.379L278.839 299.372ZM278.839 299.372C289.839 296.402 316.718 295.037 336.232 313.34C327.623 297.591 313.657 265.593 326.667 263.604L278.839 299.372ZM278.839 299.372C291.592 285.625 319.014 259.227 326.667 263.604L278.839 299.372ZM326.667 263.604C335.75 262.215 339.313 260.981 348.189 261.896L326.667 263.604ZM348.189 261.896C355.204 262.619 365.539 264.684 384.539 269.075C386.452 270.567 423.28 296.43 428.063 390.929C428.518 394.524 427.955 400.172 424.472 404.358L348.189 261.896ZM348.189 261.896C350.899 251.828 357.181 231.771 360.625 232.084L348.189 261.896ZM267.928 400.379C287.641 390.24 299.18 392.539 310.405 390.929C324.839 388.859 391.235 409.829 410.844 409.829C417.579 409.829 421.852 407.507 424.472 404.358L267.928 400.379ZM375.691 460.56C392.348 449.618 425.424 423.059 424.472 404.358L375.691 460.56ZM586.374 407.342C591.475 404.689 602.923 397.196 607.897 388.442C610.926 394.742 619.663 407.342 630.376 407.342H586.374ZM690.64 401.374C687.77 358.103 683.465 365.066 670.552 319.806C657.638 274.546 662.899 264.599 672.943 264.599C701.162 267.085 698.292 250.175 698.292 247.191C698.292 245.436 691.744 223.861 685.868 204.915L690.64 401.374ZM685.868 204.915C694.474 189.79 714.075 160.198 723.641 162.83L685.868 204.915ZM859.952 287.477C861.068 267.749 860.239 223.616 847.994 204.915C835.75 186.214 842.893 169.621 847.994 163.661L859.952 287.477ZM844.168 328.721C827.907 345.81 807.436 384.264 855.647 401.374L844.168 328.721ZM623.68 416.792C636.753 413.144 664.908 408.038 672.943 416.792H623.68ZM623.68 416.792C623.68 413.31 596.896 412.813 596.896 416.792H623.68ZM596.896 416.792C594.218 412.415 507.776 413.31 464.89 414.305L441.933 452.602L596.896 416.792ZM453.412 388.442L471.586 408.337L486.413 404.358L453.412 388.442ZM453.412 388.442C449.745 393.747 441.359 404.358 437.15 404.358L453.412 388.442ZM392.191 232.084C396.815 226.841 405.775 215.061 404.627 209.889L428.063 215.36L431.889 242.715C421.207 236.622 398.313 225.967 392.191 232.084ZM252.533 299.372C251.098 298.363 247.176 296.951 242.967 299.372C237.706 302.398 213.314 354.621 218.575 379.49C220.871 390.631 240.257 356.28 249.663 337.711C252.852 326.906 257.89 304.113 252.533 299.372ZM547.633 287.477C543.329 287.311 539.598 300.508 559.112 354.621C567.147 381.678 574.895 378.826 577.765 374.019C577.605 360.756 575.469 330.35 568.199 314.832C559.112 295.435 547.633 282.504 547.633 287.477ZM792.992 204.915C786.774 204.734 771.948 212.935 762.382 247.191C752.816 281.446 770.428 256.822 780.429 240.228C785.095 230.115 794.14 208.894 792.992 204.915Z"
          stroke="#D84367"
          stroke-width="4"
          stroke-linecap="round"
          stroke-dasharray="24 12"
        />
      </svg>

      <p class="graffDraw-display display"></p>
      <img class="graffDraw-img" src="" alt="" />
      <img
        class="graffDraw-img--preview"
        v-if="!graffInstance"
        :src="activePreviewUrl"
        alt=""
      />
      <canvas class="graffDraw-canvas"></canvas>
    </div>
    <CustomButton
      class="graffDraw-button"
      v-if="activePreviewUrl && !graffInstance"
      @click.native="valideSelectedGraff"
      :text="'Choisir ce graff'"
    />
    <ChatComponent
      class="graffDraw-chat"
      v-if="chatElementState"
      :content="currentChat"
    />
  </section>
</template>

<script lang="ts">
import { Vue, Component, getModule, Watch } from "nuxt-property-decorator";
import Graf from "~/core/interactions/Graf";
import $socket from "~/plugins/socket.io";
import chatStore from "~/store/chatStore";
import ChatComponent from "~/components/contentOverlays/chat.vue";
import CustomButton from "~/components/buttons/button.vue";
import Onboarding from "~/components/contentOverlays/onboarding";
import onboardingStore from "~/store/onboardingStore";

import { AssetsManager } from "~/core/managers";
import { IMAGE_ASSET } from "~/core/enums";

@Component({
  components: {
    CustomButton,
    ChatComponent,
  },
  async asyncData({ $prismic, error }) {
    try {
      const prismicContent = (await $prismic.api.getSingle("interaction-graff"))
        .data;

      const graffSketchsList = prismicContent.slices4.map(
        (slice: any) => slice.items
      );
      const graffDialogues = prismicContent?.slices3;
      const currentChat = graffDialogues[0];

      return {
        graffSketchsList,
        graffDialogues,
        currentChat,
      };
    } catch (e) {
      // Returns error page
      //   error({ statusCode: 404, message: 'Content not found' })
    }
  },
})
export default class GraffActivity extends Vue {
  public graffSketchsList: any;
  public graffDialogues: any;
  public currentChat: object;
  public activePreview: any | null = null;
  public activePreviewUrl: string = "";
  public graffInstance: Graf | null = null;
  public chatStore = getModule(chatStore, this.$store);
  public onboardingStore = getModule(onboardingStore, this.$store);
  public wallTexture: HTMLImageElement = new Image();

  // get chatStep from store
  get chatStep() {
    return this.chatStore.chatStep;
  }
  get chatElementState() {
    return this.chatStore.isChatDisplay;
  }

  mounted() {
    this.handleMobileSelection();
    // this.wallTexture = AssetsManager.getImage(
    //   IMAGE_ASSET.WALL_TEXTURE_GRAFF
    // ).data;
    this.chatStore.setChatDisplay(false);
  }

  handleMobileSelection() {
    $socket.io.on("graffSelected", (idx) => {
      this.activePreview = this.graffSketchsList[idx];

      this.activePreviewUrl = this.activePreview[
        this.activePreview.length - 1
      ].layer.url;
    });
  }

  valideSelectedGraff() {
    $socket.io.emit("goTo", { path: "/_mobile/graff/bomb", replace: true });

    this.graffInstance = new Graf(this.activePreview, (step: string) => {
      this.displayChat(step);
    });
  }

  displayChat(step: string) {
    for (const key in this.graffDialogues) {
      const element = this.graffDialogues[key];
      if (element.primary.Identifiant === step) {
        this.currentChat = element;
        this.chatStore.setChatDisplay(true);
      }
    }
  }

  hideChat() {
    this.chatStore.setChatDisplay(false);
  }

  @Watch("chatStep", { immediate: true, deep: true })
  setChatStep(val: string) {
    if (val) {
      switch (val) {
        case "reading":
          break;
        case "startInteraction":
          this.hideChat();
          this.chatStore.setChatStep("reading");
          break;
        case "nextBomb":
          this.graffInstance?.nextLayer();
          this.hideChat();
          this.chatStore.setChatStep("reading");
          break;
        case "leaveInteraction":
          this.$router.push({ path: "/hood", replace: true });
          this.chatStore.setChatStep("reading");
          break;
        default:
          this.displayChat(val);
          this.chatStore.setChatStep("reading");
      }
    }
  }
}
</script>